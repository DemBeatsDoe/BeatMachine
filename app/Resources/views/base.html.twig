<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>{% block title %}BeatMachine{% endblock %}</title>

        <link rel="icon" type="image/x-icon" href="{{ asset('favicon.ico') }}" />

        <!-- Bootstrap -->
        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

        <!-- Optional theme -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
        <!-- /Bootstrap -->

        <!-- Fonts -->
        <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">

        <!-- Our CSS -->
        <link rel="stylesheet" type="text/css" href="{{ asset('resources/css/base.css') }}">
        <link rel="stylesheet" type="text/css" href="{{ asset('resources/css/playbar.css') }}">
        <link rel="stylesheet" type="text/css" href="{{ asset('resources/css/header.css') }}">

        {% block stylesheets %}
        {% endblock %}

        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
        <!-- Latest compiled and minified JavaScript for bootstrap -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

        <!--Soundcloud integration scripts-->
        <script type="text/javascript" src="http://w.soundcloud.com/player/api.js"></script>

        <!--Our JS -->
        <script type="text/javascript">
            //Script for controlling soundcloud widget API
            var scWidget;
            var barCanvas;
            var ctx;
            var currentTrackIndex = 0;
            var playlist = [];

            //Function to replace the currently playing song in the playlist and start playing it
            function playNewSong(name, id) {
                playSongAt(addSongToPlaylist(name, id));
            }

            //Function to add a song to the playlist
            function addSongToPlaylist(songName, trackID) {
                playlist.push({name: songName, url:"http://api.soundcloud.com/tracks/"+trackID});
                return playlist.length-1;
            }

            //Function to play the current song
            function playSong() {
                scWidget.play();
            }

            //Function to pause the current song
            function pauseSong() {
                scWidget.pause();
            }

            //Empties the playlist
            function emptyPlaylist() {
                playlist.empty();
                currentTrackIndex = 0;
            }

            //Function to play next song
            function playNextSong() {
                currentTrackIndex = (currentTrackIndex+1)%playlist.length;
                playSongAt(currentTrackIndex);
            }

            //Function to play the previous song
            function playPrevSong() {
                currentTrackIndex = (((currentTrackIndex-1)%playlist.length)+playlist.length)%playlist.length;
                playSongAt(currentTrackIndex);
            }

            //Function to play a specific song in the playlist
            function playSongAt(index, autoplay=true) {
                redrawBar(0);
                $("#songTitleLabel").text(playlist[index].name);
                scWidget.load(playlist[index].url, {auto_play: autoplay});
                currentTrackIndex = index;
            }

            //Function to redraw the progress bar at a particular location
            function redrawBar(percentageComplete) {
                //Clear the canvas
                ctx.clearRect(0, 0, barCanvas.width, barCanvas.height);

                //Draw base line
                ctx.globalAlpha = 0.4;
                ctx.strokeStyle = "#fefefe";
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(0, barCanvas.height/2);
                ctx.lineTo(barCanvas.width, barCanvas.height/2);
                ctx.closePath();
                ctx.stroke();

                //Draw progress line
                ctx.globalAlpha = 1;
                ctx.beginPath();
                ctx.moveTo(0, barCanvas.height/2);
                ctx.lineTo(barCanvas.width*percentageComplete, barCanvas.height/2);
                ctx.closePath();
                ctx.stroke();


                //ctx.fillRect(0,0, 10,10);
            }

            //Bind widget and set event listeners
            $(function() {
                //Set canvas
                barCanvas = document.getElementById("progressBar");
                ctx = barCanvas.getContext("2d");

                //Set widget
                scWidget = SC.Widget("so");

                redrawBar(0);

                //Listen for song finish
                scWidget.bind(SC.Widget.Events.FINISH, function() {
                    playNextSong();
                });

                //Listen for progress of current song
                scWidget.bind(SC.Widget.Events.PLAY_PROGRESS, function (soundInfo ) {
                    redrawBar((soundInfo.relativePosition));
                })
            });
        </script>
    </head>

    <body>
        {% block header %}
            <div class=".container-fluid header">
                <div class="row">
                    <div class="col-md-1"></div>
                    <div class="col-md-2 location pull-left">
                        <img class="icon" src="{{ asset('resources/images/location.png') }}">
                        {% if is_granted("IS_AUTHENTICATED_REMEMBERED") %}
                            {{ app.user.location }}
                        {% else %}
                            Bath, UK
                        {% endif %}
                    </div>

                    <div class="title col-md-6"><a href="/">BEAT MACHINE</a></div>

                    <div class="loginbuttons col-md-2">
                        <ul class="pull-right">
                            {% if is_granted("IS_AUTHENTICATED_REMEMBERED") %}
                                <li class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown"><span id="usericon" class="glyphicon glyphicon-user
"></span>  Welcome, {{ app.user.username }} <b class="caret"></b></a>
                                    <ul class="dropdown-menu">
                                        <li><a href="/profile?id={{ app.user.id }}"><i class="icon-cog"></i> Profile</a></li>
                                        <li class="divider"></li>
                                        <li><a href="/logout"><i class="icon-off"></i> Logout</a></li>
                                    </ul>
                                </li>
                            {% else %}
                                <li><a href="/register"><button type="button" class="btn btn-primary">Register</button></a></li>
                                <li><a href="/login"><button type="button" class="btn btn-success">Log in</button></a></li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        {% endblock %}

        <div id="body" class="container">
            {% block body %}Empty body{% endblock %}
        </div>

        {% block playbar %}
            <div class="playbar">
                <div class="controlSection">
                    <div class="buttons">
                        <button onclick="playPrevSong();">Prev</button>
                        <button onclick="playSong();">Play</button>
                        <button onclick="pauseSong();">Pause</button>
                        <button onclick="playNextSong();">Next</button>
                    </div>
                </div>
                <div class="barSection">
                    <div id="songTitleLabel" style="padding-top: 10px; padding-bottom: 5px;">Now Playing: </div>
                    <canvas id="progressBar" width="400" height="10"></canvas>
                </div>

                <iframe style="display:none;" id="so" src="http://w.soundcloud.com/player/?url="></iframe>
            </div>
        {% endblock %}

        <!-- To be overidden -->
        {% block javascripts %}{% endblock %}
    </body>
</html>